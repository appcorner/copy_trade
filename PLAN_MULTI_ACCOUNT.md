# ЁЯУЛ р╣Бр╕Ьр╕Щр╕Ыр╕гр╕▒р╕Ър╕Ыр╕гр╕╕р╕Зр╕гр╕░р╕Ър╕Ър╕Ър╕▒р╕Нр╕Кр╕╡: Multi-Account Support

р╣Ар╕Ыр╣Йр╕▓р╕лр╕бр╕▓р╕в: р╣Ар╕Ыр╕ер╕╡р╣Ир╕вр╕Щр╕Ир╕▓р╕Б 1 Login = 1 Account р╣Ар╕Ыр╣Зр╕Щ 1 Login р╕кр╕▓р╕бр╕▓р╕гр╕Цр╕бр╕╡р╣Др╕Фр╣Йр╕лр╕ер╕▓р╕в Trading Account (Master/Follower)

---

## 1. р╕Рр╕▓р╕Щр╕Вр╣Йр╕нр╕бр╕╣р╕е (Database Schema)

р╣Ар╕гр╕▓р╕Ир╕░р╣Бр╕вр╕Бр╕Вр╣Йр╕нр╕бр╕╣р╕е "р╕Бр╕▓р╕гр╣Ар╕Чр╕гр╕Ф" р╕нр╕нр╕Бр╕Ир╕▓р╕Б "р╕Ьр╕╣р╣Йр╣Гр╕Кр╣Йр╕Зр╕▓р╕Щ"

### 1.1 р╕Хр╕▓р╕гр╕▓р╕З `users` (р╕Ыр╕гр╕▒р╕Ър╕Ыр╕гр╕╕р╕З)
р╣Ар╕Бр╣Зр╕Ър╣Ар╕Йр╕Юр╕▓р╕░р╕Вр╣Йр╕нр╕бр╕╣р╕ер╕Бр╕▓р╕гр╣Ар╕Вр╣Йр╕▓р╕кр╕╣р╣Ир╕гр╕░р╕Ър╕Ъ
- `id` (PK)
- `email`
- `hashed_password`
- `name` (р╕Кр╕╖р╣Ир╕нр╣Ар╕Ир╣Йр╕▓р╕Вр╕нр╕З User Profile)
- ~~`role`~~ (р╕ер╕Ър╕нр╕нр╕Б)
- ~~`api_key`~~ (р╕ер╕Ър╕нр╕нр╕Б)
- ~~`master_token`~~ (р╕ер╕Ър╕нр╕нр╕Б)
- ~~`copy_mode`~~ (р╕ер╕Ър╕нр╕нр╕Б)
- ~~`partner_id`~~ (р╕ер╕Ър╕нр╕нр╕Б)
- ~~`following_id`~~ (р╕ер╕Ър╕нр╕нр╕Б)

### 1.2 р╕Хр╕▓р╕гр╕▓р╕Зр╣Гр╕лр╕бр╣И `trading_accounts` (р╕лр╕гр╕╖р╕н `accounts`)
р╣Ар╕Бр╣Зр╕Ър╕Вр╣Йр╕нр╕бр╕╣р╕ер╕Юр╕нр╕гр╣Мр╕Хр╕Бр╕▓р╕гр╕ер╕Зр╕Чр╕╕р╕Щр╣Бр╕Хр╣Ир╕ер╕░р╕Юр╕нр╕гр╣Мр╕Х
- `id` (PK)
- `user_id` (FK -> users.id)
- `name` (р╕Кр╕╖р╣Ир╕нр╕Юр╕нр╕гр╣Мр╕Х р╣Ар╕Кр╣Ир╕Щ "My Aggressive Master", "Follower 1")
- `role` (enum: "master", "follower")
- `api_key` (Unique)
- `master_token` (Unique, nullable)
- `copy_mode` (default: "PUBSUB")
- `partner_id` (FK -> trading_accounts.id) **р╕кр╕▒р╕Зр╣Ар╕Бр╕Х: Reference р╕лр╕▓ table р╕Хр╕▒р╕зр╣Ар╕нр╕З**
- `following_id` (FK -> trading_accounts.id) **р╕кр╕▒р╕Зр╣Ар╕Бр╕Х: Reference р╕лр╕▓ table р╕Хр╕▒р╕зр╣Ар╕нр╕З**
- `is_active` (boolean, default: true)

---

## 2. р╕Вр╕▒р╣Йр╕Щр╕Хр╕нр╕Щр╕Бр╕▓р╕гр╕Чр╕│р╕Зр╕▓р╕Щ (Workflow Changes)

### 2.1 р╕лр╕Щр╣Йр╕▓р╣Ар╕зр╣Зр╕Ър╣Др╕Лр╕Хр╣М (Web Dashboard)
1.  **Login:** р╣Ар╕Вр╣Йр╕▓р╕кр╕╣р╣Ир╕гр╕░р╕Ър╕Ър╕Фр╣Йр╕зр╕в Email/Password р╕Хр╕▓р╕бр╣Ар╕Фр╕┤р╕б
2.  **Accounts List:** р╣Бр╕Чр╕Щр╕Чр╕╡р╣Ир╕Ир╕░р╣Ар╕Вр╣Йр╕▓р╕кр╕╣р╣И Dashboard р╣Ар╕ер╕в р╕Ир╕░р╣Ар╕Ир╕нр╕лр╕Щр╣Йр╕▓р╕гр╕зр╕бр╕Ър╕▒р╕Нр╕Кр╕╡ (My Trading Accounts)
    *   р╣Бр╕кр╕Фр╕Зр╕гр╕▓р╕вр╕Бр╕▓р╕гр╕Ър╕▒р╕Нр╕Кр╕╡р╕Чр╕╡р╣Ир╕бр╕╡р╕нр╕вр╕╣р╣И
    *   р╕Ыр╕╕р╣Ир╕б "+ Create New Account"
3.  **Account Management:**
    *   р╣Ар╕бр╕╖р╣Ир╕нр╕Бр╕Фр╕кр╕гр╣Йр╕▓р╕З: р╣Гр╕лр╣Йр╣Гр╕кр╣Ир╕Кр╕╖р╣Ир╕нр╣Ар╕ер╕╖р╕нр╕Б Role (Master/Follower)
    *   р╣Ар╕бр╕╖р╣Ир╕нр╕кр╕гр╣Йр╕▓р╕Зр╣Ар╕кр╕гр╣Зр╕И: р╕гр╕░р╕Ър╕Ъ Gen `API Key` р╣Гр╕лр╣Йр╣Гр╕лр╕бр╣Ир╕кр╕│р╕лр╕гр╕▒р╕Ър╕Ър╕▒р╕Нр╕Кр╕╡р╕Щр╕▒р╣Йр╕Щр╣Ж
4.  **Dashboard View:** р╕Ьр╕╣р╣Йр╣Гр╕Кр╣Йр╕Хр╣Йр╕нр╕З "р╣Ар╕ер╕╖р╕нр╕Б" р╕Ър╕▒р╕Нр╕Кр╕╡р╕Чр╕╡р╣Ир╕Ир╕░р╕Фр╕╣ Dashboard (р╕лр╕гр╕╖р╕нр╣Ар╕Ыр╕┤р╕Фр╕лр╕ер╕▓р╕в Tab р╣Др╕Фр╣Й)

### 2.2 р╕Бр╕▓р╕гр╕Чр╕│р╕Зр╕▓р╕Щр╕Вр╕нр╕З TCP Server
1.  **Authentication:**
    *   р╣Ар╕Фр╕┤р╕б: `AUTH:API_KEY` -> р╕Др╣Йр╕Щр╕лр╕▓ `User`
    *   р╣Гр╕лр╕бр╣И: `AUTH:API_KEY` -> р╕Др╣Йр╕Щр╕лр╕▓ `TradingAccount`
2.  **Logic р╕ар╕▓р╕вр╣Гр╕Щ:**
    *   р╣Ар╕Ыр╕ер╕╡р╣Ир╕вр╕Щр╕Бр╕▓р╕гр╕нр╣Йр╕▓р╕Зр╕нр╕┤р╕З `user_id` р╣Ар╕Ыр╣Зр╕Щ `account_id` р╣Гр╕Щр╕Чр╕╕р╕Б Context (TradePair, MasterTrade)
    *   `account_id` р╕Ир╕░р╕Бр╕ер╕▓р╕вр╣Ар╕Ыр╣Зр╕Щ Identity р╕лр╕ер╕▒р╕Бр╣Гр╕Щр╕гр╕░р╕Ър╕Ъ Trading

---

## 3. р╣Бр╕Ьр╕Щр╕Бр╕▓р╕гр╣Бр╕Бр╣Йр╣Др╕В Code (Implementation Plan)

### Phase 1: Database Migration
1.  р╕кр╕гр╣Йр╕▓р╕З Migration `create_trading_accounts`
2.  р╣Ар╕Вр╕╡р╕вр╕Щ Script р╕вр╣Йр╕▓р╕вр╕Вр╣Йр╕нр╕бр╕╣р╕ер╣Ар╕Бр╣Ир╕▓р╕Ир╕▓р╕Б `users` -> `trading_accounts` (р╣Ар╕Юр╕╖р╣Ир╕нр╣Гр╕лр╣Й User р╣Ар╕Бр╣Ир╕▓р╕вр╕▒р╕Зр╣Гр╕Кр╣Йр╕Зр╕▓р╕Щр╣Др╕Фр╣Й)
3.  р╕кр╕гр╣Йр╕▓р╕З Migration `remove_trading_fields_from_users`

### Phase 2: Backend Context
1.  р╕кр╕гр╣Йр╕▓р╕З Schema `CopyTrade.Accounts.TradingAccount`
2.  р╣Бр╕Бр╣Йр╣Др╕В `CopyTrade.Accounts` context:
    *   р╣Ар╕Юр╕┤р╣Ир╕б `create_trading_account`
    *   р╣Ар╕Юр╕┤р╣Ир╕б `list_trading_accounts(user_id)`
    *   р╣Ар╕Ыр╕ер╕╡р╣Ир╕вр╕Щ `get_user_by_api_key` р╣Ар╕Ыр╣Зр╕Щ `get_account_by_api_key`

### Phase 3: TCP Server Refactor
1.  р╣Ар╕Ыр╕ер╕╡р╣Ир╕вр╕Щ Logic р╣Гр╕Щ `tcp_server.ex`:
    *   `state.user_id` -> `state.account_id`
    *   р╕Бр╕▓р╕гр╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ъ Role р╣Бр╕ер╕░ Partner р╣Гр╕лр╣Йр╣Ар╕Кр╣Зр╕Др╕Ир╕▓р╕Б `TradingAccount` struct

### Phase 4: Frontend Update
1.  р╕кр╕гр╣Йр╕▓р╕Зр╕лр╕Щр╣Йр╕▓ LiveView р╣Гр╕лр╕бр╣И `AccountIndexLive`
2.  р╣Бр╕Бр╣Йр╣Др╕В `DashboardLive` р╣Гр╕лр╣Йр╕гр╕▒р╕Ъ parameter р╣Ар╕Ыр╣Зр╕Щ `account_id`
3.  р╣Ар╕Юр╕┤р╣Ир╕б UI р╕кр╕│р╕лр╕гр╕▒р╕Ър╕кр╕гр╣Йр╕▓р╕З/р╕ер╕Ъ Account

---

## 4. р╕кр╕┤р╣Ир╕Зр╕Чр╕╡р╣Ир╕Хр╣Йр╕нр╕Зр╣Бр╕ер╕Б (Trade-offs)
*   User р╣Ар╕Бр╣Ир╕▓р╕нр╕▓р╕Ир╕Ир╕░р╕Зр╕Зр╣Ар╕ер╣Зр╕Бр╕Щр╣Йр╕нр╕вр╕Чр╕╡р╣Ир╣Вр╕Др╕гр╕Зр╕кр╕гр╣Йр╕▓р╕Зр╣Ар╕Ыр╕ер╕╡р╣Ир╕вр╕Щ (р╣Бр╕Хр╣Ир╣Ар╕гр╕▓ Migrate р╣Гр╕лр╣Й)
*   Code р╣Гр╕Щр╕кр╣Ир╕зр╕Щ `TcpServer` р╣Бр╕ер╕░ `Context` р╕Хр╣Йр╕нр╕Зр╕гр╕╖р╣Йр╕нр╣Бр╕Бр╣Йр╣Ар╕вр╕нр╕░р╕Юр╕нр╕кр╕бр╕Др╕зр╕г р╣Вр╕Фр╕вр╣Ар╕Йр╕Юр╕▓р╕░р╕кр╣Ир╕зр╕Щ Reference ID

р╣Бр╕Ир╣Йр╕Зр╕вр╕╖р╕Щр╕вр╕▒р╕Щр╣Ар╕Юр╕╖р╣Ир╕нр╣Ар╕гр╕┤р╣Ир╕бр╕Фр╕│р╣Ар╕Щр╕┤р╕Щр╕Бр╕▓р╕гр╣Др╕Фр╣Йр╣Ар╕ер╕вр╕Др╕гр╕▒р╕Ъ! ЁЯЪА
